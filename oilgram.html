<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oilgram — Oil Token Chat (OIL)</title>
  <style>
    :root{
      --bg:#ffffff;
      --accent:#6a00ff;
      --muted:#666;
      --card:#f7f7fb;
      --success:#10b981;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.8);
      --radius:12px;
      --gap:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#fff,#f3f6ff);color:#111}
    .wrap{max-width:1100px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;gap:14px;justify-content:space-between}
    header h1{margin:0;font-size:20px;color:var(--accent)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 30px rgba(20,20,50,0.06)}
    .small{font-size:13px;color:var(--muted)}
    input,textarea,select,button{font-family:inherit;font-size:14px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e2e8f0;background:#fff;box-sizing:border-box}
    button{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center}
    .center{display:flex;justify-content:center;align-items:center}
    .notice{font-size:13px;color:#333;padding:8px;border-radius:8px;background:linear-gradient(90deg,#fff8e1,#fff);margin-top:8px}
    .phone-input{display:flex;gap:8px;align-items:center}
    .phone-input input{flex:1}
    .list{max-height:360px;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px}
    .message{padding:8px;border-radius:10px;background:#fff;box-shadow:0 3px 10px rgba(10,20,40,0.03);max-width:78%}
    .message.me{background:linear-gradient(90deg,#e6f7ff,#d9f2ff);margin-left:auto}
    .message .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ghost{background:transparent;border:1px solid #ddd;color:#111;padding:8px;border-radius:10px;cursor:pointer}
    .bigbtn{padding:12px 14px;border-radius:12px}
    .top-controls{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:880px){ .grid{grid-template-columns:1fr; } .card{padding:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Oilgram — Oil Token (OIL)</h1>
      <div class="small">Secure chat for OilToken community — multi-chain & communication-ready</div>
    </header>

    <div class="grid">

      <!-- LEFT COLUMN: AUTH + PROFILE + PHONE SELECTION -->
      <div class="card" id="authCard">
        <h3 id="authTitle">Sign up / Sign in</h3>

        <!-- Sign Up / Sign In Forms -->
        <div id="authForms">
          <div id="signupBox">
            <div class="small">Create account</div>
            <input id="suEmail" type="email" placeholder="Email" />
            <input id="suPass" type="password" placeholder="Password (min 6)" />
            <div style="margin-top:6px" class="phone-input">
              <div style="min-width:72px;padding:10px;background:#fff;border-radius:8px;border:1px solid #e2e8f0">+666</div>
              <input id="suPhonePart" type="text" placeholder="Choose 7 digits (e.g. 1234567)" maxlength="7" />
            </div>
            <div class="notice" id="phoneNotice">
              🔒 فعلا شماره‌هایی که بعد از کد 666 سه رقم یا بیشتر مشابه هم دارند برای واگذاری از طریق مزایده و عادلانه فعلا قفل هستند؛ سیستم از ارائه این شماره‌ها معذور می‌باشد.
            </div>
            <div style="margin-top:10px" class="row">
              <button id="btnSignup">Sign up</button>
              <button class="ghost" id="showSignin">I already have an account</button>
            </div>
          </div>

          <div id="signinBox" class="hidden">
            <div class="small">Sign in</div>
            <input id="inEmail" type="email" placeholder="Email" />
            <input id="inPass" type="password" placeholder="Password" />
            <div style="margin-top:10px" class="row">
              <button id="btnSignin">Sign in</button>
              <button class="ghost" id="showSignup">Create account</button>
            </div>
          </div>
        </div>

        <!-- Profile area -->
        <div id="profileBox" class="hidden" style="margin-top:12px">
          <div class="small">Signed in as</div>
          <div id="profileInfo" style="margin:8px 0"></div>
          <div class="small">Your assigned number</div>
          <div id="profilePhone" style="font-weight:800;margin:8px 0"></div>

          <div class="controls">
            <button id="btnLogout" class="ghost">Logout</button>
            <button id="btnDeleteAccount" class="ghost">Delete account</button>
          </div>
        </div>

        <hr style="margin:12px 0">

        <div class="small">Admin / debug</div>
        <div class="row" style="margin-top:8px">
          <input id="adminPass" type="password" placeholder="admin password (for admin actions)"/>
          <button id="btnAdminLogin" class="ghost">Admin Login</button>
        </div>
        <div id="adminNote" class="small muted" style="margin-top:8px">Admin features controlled separately.</div>

      </div>

      <!-- RIGHT COLUMN: CHAT -->
      <div class="card">
        <div class="top-controls">
          <div style="flex:1">
            <div class="small">Active mode:</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <button id="showPublicBtn" class="ghost bigbtn">Public Chat</button>
              <button id="showPrivateBtn" class="ghost bigbtn">Private Chat</button>
              <div style="margin-left:12px" class="small muted">Voice → Video Flow</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="voiceBtn" class="ghost" title="Voice call (coming soon)">🎧 Voice Call</button>
            <button id="videoBtn" class="ghost" title="Video call (coming soon)">📹 Video Call</button>
          </div>
        </div>

        <hr style="margin:12px 0">

        <!-- Chat area -->
        <div id="publicArea" class="">
          <div class="small">Public chat (all users)</div>
          <div id="publicList" class="list" style="margin-top:8px"></div>
        </div>

        <div id="privateArea" class="hidden">
          <div class="small">Private chat — enter recipient 666xxxxxxx</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="privateRecipient" placeholder="Recipient phone (full, e.g. 6661234567)" />
            <button id="openPrivateChat" class="ghost">Open</button>
          </div>
          <div id="privateHeader" class="small muted" style="margin-top:10px"></div>
          <div id="privateList" class="list" style="margin-top:8px"></div>
        </div>

        <!-- send box -->
        <div style="margin-top:12px;display:flex;gap:8px;align-items:start">
          <input id="chatInput" placeholder="Type your message..." />
          <button id="sendBtn">Send</button>
        </div>

        <div id="status" class="small muted" style="margin-top:8px"></div>
      </div>
    </div>

    <footer>
      <div class="small">Oilgram — built for OilToken community. Voice & Video placeholders are ready; real-time calls require WebRTC server / signaling which can be enabled in next step.</div>
    </footer>
  </div>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getDatabase, ref, set, push, onChildAdded, query, orderByChild, equalTo, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    // ----- YOUR EXISTING FIREBASE CONFIG (you provided this earlier) -----
    const firebaseConfig = {
      apiKey: "AIzaSyCGDY_ij0EjS-RDSXF0RQCyoc6yYLXyPXE",
      authDomain: "oilgram.firebaseapp.com",
      databaseURL: "https://oilgram-default-rtdb.firebaseio.com",
      projectId: "oilgram",
      storageBucket: "oilgram.firebasestorage.app",
      messagingSenderId: "555429946689",
      appId: "1:555429946689:web:a23a918ca6ceb3e8936dc0",
      measurementId: "G-BSEWJHYD29"
    };
    // ---------------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM references
    const suEmail = document.getElementById('suEmail'), suPass = document.getElementById('suPass'), suPhonePart = document.getElementById('suPhonePart');
    const btnSignup = document.getElementById('btnSignup'), btnSignin = document.getElementById('btnSignin'), inEmail = document.getElementById('inEmail'), inPass = document.getElementById('inPass');
    const showSignin = document.getElementById('showSignin'), showSignup = document.getElementById('showSignup');
    const profileBox = document.getElementById('profileBox'), profileInfo = document.getElementById('profileInfo'), profilePhone = document.getElementById('profilePhone');
    const signupBox = document.getElementById('signupBox'), signinBox = document.getElementById('signinBox');
    const btnLogout = document.getElementById('btnLogout'), btnDeleteAccount = document.getElementById('btnDeleteAccount');
    const publicList = document.getElementById('publicList'), privateList = document.getElementById('privateList'), publicArea = document.getElementById('publicArea'), privateArea = document.getElementById('privateArea');
    const sendBtn = document.getElementById('sendBtn'), chatInput = document.getElementById('chatInput'), status = document.getElementById('status');
    const showPublicBtn = document.getElementById('showPublicBtn'), showPrivateBtn = document.getElementById('showPrivateBtn'), openPrivateChat = document.getElementById('openPrivateChat'), privateRecipient = document.getElementById('privateRecipient');
    const newsRefPublic = ref(db, 'publicMessages');
    const adminPassInput = document.getElementById('adminPass'), btnAdminLogin = document.getElementById('btnAdminLogin');
    const voiceBtn = document.getElementById('voiceBtn'), videoBtn = document.getElementById('videoBtn');
    const phoneNotice = document.getElementById('phoneNotice');

    // predefined locked list (the list you gave earlier)
    const STATIC_LOCKED = [
      "6660000000","6661111111","6662222222","6663333333","6664444444","6665555555","6666666666","6667777777","6668888888","6669999999",
      "6660001111","6660002222","6660003333","6660004444","6660005555","6660006666","6660007777","6660008888","6660009999",
      "6661110000","6662220000","6663330000","6664440000","6665550000","6666660000","6667770000","6668880000","6669990000",
      "6661000000","6662000000","6663000000","6664000000","6665000000","6666000000","6667000000","6668000000","6669000000"
    ];

    // Helper - check for triple-or-more identical digits in a row
    function hasTripleRepeat(s){
      // expects full 10-digit string ('666' + 7 digits)
      return /(\d)\1\1/.test(s);
    }

    // check premiumNumbers node in DB (if admin populated it)
    async function isInPremiumList(full) {
      try {
        const snap = await get(ref(db, 'premiumNumbers/' + full));
        if (snap && snap.exists()) return true;
        // fallback: check STATIC_LOCKED
        return STATIC_LOCKED.includes(full);
      } catch(e){ console.error('premium check error', e); return STATIC_LOCKED.includes(full); }
    }

    // check if phone already taken
    async function isPhoneTaken(full){
      const q = query(ref(db, 'users'), orderByChild('phone'), equalTo(full));
      const snap = await get(q);
      return snap && snap.exists();
    }

    // create user record in RTDB under /users/{uid}
    async function createUserRecord(uid, email, fullPhone){
      await set(ref(db, 'users/' + uid), { email, phone: fullPhone, createdAt: Date.now() });
    }

    // UI helpers
    function showProfile(uid,email,phone){
      profileBox.classList.remove('hidden');
      signupBox.classList.add('hidden'); signinBox.classList.add('hidden');
      profileInfo.innerText = email || uid;
      profilePhone.innerText = phone || '—';
    }
    function showAuthForms(){
      profileBox.classList.add('hidden');
      signupBox.classList.remove('hidden');
      signinBox.classList.add('hidden');
    }

    // --- Auth flows ---
    btnSignup.addEventListener('click', async ()=>{
      const email = suEmail.value.trim(), pass = suPass.value;
      const phonePart = suPhonePart.value.trim();
      if (!email || !pass || !phonePart){ alert('Please complete email, password and 7-digit phone part.'); return; }
      if (pass.length < 6){ alert('Password must be 6+ chars'); return; }
      if (!/^\d{7}$/.test(phonePart)){ alert('Phone part must be 7 digits'); return; }
      const full = '666' + phonePart;
      // check locked and pattern
      if (await isInPremiumList(full) || hasTripleRepeat(full)){
        alert('This number is currently locked and cannot be assigned. It will be available via auction in future.');
        return;
      }
      if (await isPhoneTaken(full)){
        alert('This number is already taken, please choose another.');
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;
        await createUserRecord(uid, email, full);
        // store phone under profile via set again if needed (already done)
        alert('Account created successfully. You are signed in.');
      } catch(err){
        console.error(err);
        alert('Signup error: ' + (err.message || err.code));
      }
    });

    btnSignin.addEventListener('click', async ()=>{
      const email = inEmail.value.trim(), pass = inPass.value;
      if (!email || !pass){ alert('Enter email/password'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch(err){ console.error(err); alert('Signin error: '+(err.message||err.code)); }
    });

    btnLogout.addEventListener('click', async ()=>{
      await signOut(auth);
      location.reload();
    });

    btnDeleteAccount.addEventListener('click', async ()=>{
      if (!confirm('Delete your account? This is irreversible.')) return;
      const user = auth.currentUser;
      try {
        await deleteUser(user);
        alert('Account deleted.');
        location.reload();
      } catch(err){ console.error(err); alert('Delete error: '+(err.message||err.code)); }
    });

    // handle auth state
    onAuthStateChanged(auth, async (u)=>{
      if (u){
        // load user's phone from DB
        const snap = await get(ref(db,'users/' + u.uid));
        const data = snap && snap.exists() ? snap.val() : null;
        showProfile(u.uid, u.email, data && data.phone ? data.phone : '—');
        setupRealtimePublic();
        status.innerText = 'Connected as ' + (data && data.phone ? data.phone : u.email);
      } else {
        showAuthForms();
        status.innerText = 'Not signed in';
      }
    });

    // switch forms
    showSignin.addEventListener('click', ()=>{ signupBox.classList.add('hidden'); signinBox.classList.remove('hidden'); });
    showSignup.addEventListener('click', ()=>{ signinBox.classList.add('hidden'); signupBox.classList.remove('hidden'); });

    // ---------- Public chat ----------
    function setupRealtimePublic(){
      // listen to last items
      onChildAdded(ref(db,'publicMessages'), (snap)=>{
        const data = snap.val();
        if (!data) return;
        appendPublicMessage(data);
      });
    }

    function appendPublicMessage(data){
      const el = document.createElement('div');
      el.className = 'message' + (data.senderUid === (auth.currentUser && auth.currentUser.uid) ? ' me' : '');
      el.innerHTML = `<div class="meta">${escapeHtml(data.senderPhone || data.senderEmail || 'anon')} • ${new Date(data.ts || Date.now()).toLocaleString()}</div>
      <div>${escapeHtml(data.text)}</div>`;
      publicList.appendChild(el);
      publicList.scrollTop = publicList.scrollHeight;
    }

    // ---------- Private chat helpers ----------
    let currentPrivateChatId = null;
    function makePrivateChatId(uidA, uidB){
      // deterministic id: smaller_uid__larger_uid
      return uidA < uidB ? uidA + '__' + uidB : uidB + '__' + uidA;
    }

    async function openPrivateWithPhone(phone){
      // find user by phone
      const q = query(ref(db,'users'), orderByChild('phone'), equalTo(phone));
      const snap = await get(q);
      if (!snap || !snap.exists()){
        alert('Recipient not found: ' + phone);
        return;
      }
      const entries = Object.entries(snap.val());
      const recipientUid = entries[0][0];
      const meUid = auth.currentUser.uid;
      currentPrivateChatId = makePrivateChatId(meUid, recipientUid);
      document.getElementById('privateHeader').innerText = 'Private chat with ' + phone;
      privateList.innerHTML = '';
      // listen
      const pRef = ref(db, 'privateMessages/' + currentPrivateChatId);
      onChildAdded(pRef, (csnap)=>{
        const data = csnap.val();
        if (!data) return;
        appendPrivateMessage(data);
      });
      // reveal private area
      publicArea.classList.add('hidden'); privateArea.classList.remove('hidden');
    }

    function appendPrivateMessage(data){
      const el = document.createElement('div');
      el.className = 'message' + (data.senderUid === (auth.currentUser && auth.currentUser.uid) ? ' me' : '');
      el.innerHTML = `<div class="meta">${escapeHtml(data.senderPhone||data.senderEmail||'anon')} • ${new Date(data.ts||Date.now()).toLocaleString()}</div>
      <div>${escapeHtml(data.text)}</div>`;
      privateList.appendChild(el);
      privateList.scrollTop = privateList.scrollHeight;
    }

    openPrivateChat.addEventListener('click', async ()=>{
      const phone = privateRecipient.value.trim();
      if (!/^\d{10}$/.test(phone) || !phone.startsWith('666')) { alert('Enter full phone like 6661234567'); return; }
      if (!auth.currentUser){ alert('Sign in first'); return; }
      await openPrivateWithPhone(phone);
    });

    // ---------- send messages ----------
    sendBtn.addEventListener('click', async ()=>{
      const text = chatInput.value.trim();
      if (!text) return;
      const user = auth.currentUser;
      if (!user) { alert('Sign in first'); return; }
      const meUid = user.uid;
      const meSnap = await get(ref(db, 'users/' + meUid));
      const meData = meSnap.exists() ? meSnap.val() : {};
      const payload = { text, senderUid: meUid, senderEmail: user.email, senderPhone: meData.phone || null, ts: Date.now() };

      if (privateArea.classList.contains('hidden')){
        // public
        await push(ref(db,'publicMessages'), payload);
      } else {
        // private
        if (!currentPrivateChatId){ alert('Open a private chat first'); return; }
        await push(ref(db,'privateMessages/' + currentPrivateChatId), payload);
      }
      chatInput.value = '';
    });

    // ---------- list live public messages (load recent at start) ----------
    async function loadRecentPublic(){
      // load and render last 200 messages (simple approach)
      // We'll attach onChildAdded already; this will gradually fill as database pushes arrive.
      // If you want to read existing messages at load:
      const p = await get(ref(db,'publicMessages'));
      if (p && p.exists()){
        const val = p.val();
        const items = Object.values(val).slice(-200);
        publicList.innerHTML = '';
        items.forEach(appendPublicMessage);
      }
    }
    loadRecentPublic();

    // ---------- show/hide chat modes ----------
    showPublicBtn.addEventListener('click', ()=>{ publicArea.classList.remove('hidden'); privateArea.classList.add('hidden'); currentPrivateChatId = null; });
    showPrivateBtn.addEventListener('click', ()=>{ publicArea.classList.add('hidden'); privateArea.classList.remove('hidden'); });

    // ---------- utility: escapeHtml ----------
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]}); }

    // ---------- admin login (simple client-side gate for admin buttons) ----------
    btnAdminLogin.addEventListener('click', ()=>{
      const p = adminPassInput.value.trim();
      if (p === 'oilteam2025'){ adminPassInput.value=''; alert('Admin unlocked (client-side). Use DB console for real admin ops).'); }
      else alert('Incorrect admin password.');
    });

    // ---------- phone selection validation example (used at signup) ----------
    // Note: already implemented in signup flow. This area left for any extra inline checks.

    // ---------- Voice/Video buttons (placeholders with stepwise plan) ----------
    voiceBtn.addEventListener('click', ()=>{
      // Phase 1: capture mic and establish WebRTC with signaling (coming next)
      alert('Voice call flow is prepared. Full voice calling requires a signaling server (or Firebase-based signaling) and user media permissions. Implementation planned as next step.');
    });
    videoBtn.addEventListener('click', ()=>{
      alert('Video calling planned after voice is live. It will require WebRTC + TURN/STUN servers for reliability.');
    });

    // ---------- helper: check if phone exists and available (utility for signup UI if needed) ----------
    async function checkPhoneAvailability(part){
      if (!/^\d{7}$/.test(part)) return {ok:false, reason:'invalid'};
      const full = '666' + part;
      if (await isInPremiumList(full) || hasTripleRepeat(full)) return {ok:false, reason:'locked'};
      if (await isPhoneTaken(full)) return {ok:false, reason:'taken'};
      return {ok:true};
    }

    // allow pressing Enter in input to send
    chatInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); }});
    privateRecipient.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); openPrivateChat.click(); }});
  </script>
</body>
            </html>
