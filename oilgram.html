<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oilgram — Voice Calls (OIL)</title>
  <style>
    :root{ --bg:#fff; --accent:#0b74ff; --muted:#666; --card-radius:12px; }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial; margin:0; background:var(--bg); color:#111;}
    .wrap{max-width:980px;margin:18px auto;padding:18px}
    .card{background:#fff;border-radius:var(--card-radius);padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
    input,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e9;margin:6px 0}
    .row{display:flex;gap:8px}
    .small{font-size:13px;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid #eee}
    .hidden{display:none}
    audio{width:100%;border-radius:8px;background:#000}
    .reserved{color:#b91c1c;font-weight:700}
    label{font-weight:700;font-size:13px}
    pre.note{background:#f7f8fa;padding:10px;border-radius:8px;border:1px solid #eee}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center">
      <h2>Oilgram — Voice Calls (OIL)</h2>
      <div class="small">Email/password auth • Assign 10-digit code starting with <strong>666</strong></div>
    </header>

    <div style="margin-top:16px">
      <div class="card" id="authCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Sign up / Login</strong>
            <div class="small">Sign up with email/password. Verify email to assign codes and use calls.</div>
          </div>
          <div id="profileBox" class="hidden">
            <div id="meEmail" style="font-weight:700"></div>
            <div id="meCode" class="small"></div>
            <button class="btn ghost" id="btnLogout">Logout</button>
          </div>
        </div>

        <div id="authForms" style="margin-top:10px">
          <div id="signup">
            <label>Email</label><input id="suEmail" type="email" placeholder="you@example.com" />
            <label>Password</label><input id="suPass" type="password" placeholder="min 6 chars" />
            <label>Choose code (optional)</label><input id="suCode" placeholder="6661234567 (optional)" />
            <div class="row" style="margin-top:8px">
              <button class="btn" id="btnSignup">Sign Up</button>
              <button class="btn ghost" id="btnShowLogin">Login</button>
            </div>
          </div>

          <div id="login" class="hidden">
            <label>Email</label><input id="liEmail" type="email" />
            <label>Password</label><input id="liPass" type="password" />
            <div class="row" style="margin-top:8px">
              <button class="btn" id="btnLogin">Login</button>
              <button class="btn ghost" id="btnShowSignup">Back</button>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Assign / Reserve number</label>
            <input id="chosenNumber" placeholder="6661234567" />
            <div class="small" id="numNotice">Numbers with 3 identical digits in a row after 666 are reserved for auction.</div>
            <div class="row">
              <button class="btn" id="btnCheck">Check</button>
              <button class="btn ghost" id="btnAssign">Assign</button>
            </div>
            <div id="numFeedback" class="small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Voice Call (1:1)</strong>
        <div class="small">Make a P2P voice call. Both users must be signed in and email-verified. Create a call (offer) and share Call ID with recipient.</div>

        <div style="margin-top:10px" class="row">
          <button class="btn" id="createCallBtn">Create Call (offer)</button>
          <button class="btn ghost" id="joinCallBtn">Join Call (enter ID)</button>
        </div>

        <div id="callUI" class="hidden" style="margin-top:12px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div style="flex:1"><div class="small">Local</div><audio id="localAudio" controls autoplay muted></audio></div>
            <div style="flex:1"><div class="small">Remote</div><audio id="remoteAudio" controls autoplay></audio></div>
          </div>

          <div style="margin-top:10px" class="row">
            <input id="callIdField" placeholder="Call ID" />
            <button class="btn" id="copyCallId">Copy ID</button>
          </div>

          <div style="margin-top:8px">
            <button class="btn ghost" id="hangupBtn">Hang up</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <strong>Reserved codes (examples)</strong>
        <div class="small" style="margin-top:8px">Examples — blocked for auction / sale.</div>
        <div style="margin-top:8px" id="reservedList"></div>
      </div>

      <div style="margin-top:12px" class="card">
        <label class="small">Search user by code</label>
        <input id="searchCode" placeholder="6661234567" />
        <button class="btn" id="btnSearch">Find</button>
        <div id="searchResult" class="small" style="margin-top:8px"></div>
      </div>

    </div>
  </div>

  <!-- private-config.js should set window.__FIREBASE_CONFIG = {...} -->
  <script src="private-config.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // load config from private-config.js (expects window.__FIREBASE_CONFIG)
    const cfg = window.__FIREBASE_CONFIG || {};
    if(!cfg || !cfg.projectId){ console.warn('Missing firebase config. Put real config into private-config.js'); }

    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // -------- helpers --------
    const $ = id => document.getElementById(id);
    const normalize = s => String(s||"").replace(/\D/g,"").slice(0,10);
    const isValidCode = s => /^666\d{7}$/.test(normalize(s));
    const hasTriple = s => /(.)\1\1/.test(normalize(s).slice(3));
    function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // reserved list (examples)
    const reservedNumbers = new Set([
      "6660000000","6661111111","6662222222","6663333333","6664444444","6665555555","6666666666",
      "6667777777","6668888888","6669999999",
      "6660001111","6660002222","6660003333","6660004444","6660005555","6660006666","6660007777","6660008888","6660009999",
      "6661110000","6662220000","6663330000","6664440000","6665550000","6666660000","6667770000","6668880000","6669990000",
      "6661000000","6662000000","6663000000","6664000000","6665000000","6666000000","6667000000","6668000000","6669000000"
    ]);
    function renderReserved(){ const el = $("reservedList"); el.innerHTML = ""; for(const c of reservedNumbers){ const d=document.createElement("div"); d.className="small"; d.textContent=c; el.appendChild(d); } }
    renderReserved();

    // UI wiring
    $("btnShowLogin").onclick = ()=>{ $("signup").classList.add('hidden'); $("login").classList.remove('hidden'); };
    $("btnShowSignup").onclick = ()=>{ $("signup").classList.remove('hidden'); $("login").classList.add('hidden'); };

    // Signup
    $("btnSignup").onclick = async ()=>{
      const email = $("suEmail").value.trim();
      const pass = $("suPass").value;
      if(!email || pass.length < 6){ alert("Enter email + password (min 6 chars)"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await sendEmailVerification(cred.user);
        await setDoc(doc(db,"users", cred.user.uid), { email, code: null, createdAt: Date.now() });
        alert("Signed up. Verification email sent — confirm email, then assign a code.");
      }catch(e){ console.error(e); alert("Sign up error: " + (e.message||e)); }
    };

    // Login
    $("btnLogin").onclick = async ()=>{
      const email = $("liEmail").value.trim();
      const pass = $("liPass").value;
      if(!email || !pass){ alert("Enter email & password"); return; }
      try{ await signInWithEmailAndPassword(auth, email, pass); } catch(e){ alert("Login error: " + (e.message||e)); }
    };

    $("btnLogout").onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async user=>{
      if(user){
        $("profileBox").classList.remove('hidden');
        $("authForms").classList.add('hidden');
        $("meEmail").textContent = user.email + (user.emailVerified ? " (verified)" : " (verify email)");
        const ud = await getDoc(doc(db,"users", user.uid));
        const data = ud.exists() ? ud.data() : {};
        $("meCode").textContent = data.code ? "Code: " + data.code : "Code: not assigned";
      } else {
        $("profileBox").classList.add('hidden');
        $("authForms").classList.remove('hidden');
      }
    });

    // Check & Assign
    $("btnCheck").onclick = async ()=>{
      const raw = normalize($("chosenNumber").value);
      if(!isValidCode(raw)){ $("numFeedback").textContent="Format invalid"; $("numFeedback").style.color="red"; return; }
      if(reservedNumbers.has(raw) || hasTriple(raw)){ $("numFeedback").textContent="Reserved for auction"; $("numFeedback").style.color="red"; return; }
      const docSnap = await getDoc(doc(db,"userCodes", raw));
      if(docSnap.exists()){ $("numFeedback").textContent="Taken"; $("numFeedback").style.color="red"; return; }
      $("numFeedback").textContent="Available ✅"; $("numFeedback").style.color="green";
    };

    $("btnAssign").onclick = async ()=>{
      const user = auth.currentUser;
      if(!user){ alert("Login first"); return; }
      if(!user.emailVerified){ alert("You must verify your email before assigning a code."); return; }
      const raw = normalize($("chosenNumber").value);
      if(!isValidCode(raw)){ $("numFeedback").textContent="Invalid format"; $("numFeedback").style.color="red"; return; }
      if(reservedNumbers.has(raw) || hasTriple(raw)){ $("numFeedback").textContent="Reserved"; $("numFeedback").style.color="red"; return; }
      const taken = await getDoc(doc(db,"userCodes", raw));
      if(taken.exists()){ $("numFeedback").textContent="Taken"; $("numFeedback").style.color="red"; return; }
      await setDoc(doc(db,"userCodes", raw), { uid: user.uid, code: raw, createdAt: Date.now() });
      await updateDoc(doc(db,"users", user.uid), { code: raw }).catch(async()=>{ await setDoc(doc(db,"users", user.uid), { email: user.email, code: raw }); });
      $("numFeedback").textContent="Assigned ✅"; $("numFeedback").style.color="green";
      $("meCode").textContent = "Code: " + raw;
    };

    // WebRTC calls (Firestore signaling)
    let localStream = null;
    let pc = null;
    let callDoc = null;
    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    async function startLocalAudio(){
      if(localStream) return;
      try{
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        const localEl = $("localAudio");
        localEl.srcObject = localStream;
        localEl.muted = true;
      }catch(e){ alert("Microphone access denied: " + e.message); throw e; }
    }

    $("createCallBtn").onclick = async ()=>{
      if(!auth.currentUser){ alert("Login required"); return; }
      if(!auth.currentUser.emailVerified){ alert("Your email must be verified"); return; }
      await startLocalAudio();
      pc = new RTCPeerConnection(servers);
      let remoteStream = new MediaStream();
      $("remoteAudio").srcObject = remoteStream;
      pc.ontrack = (event) => {
        event.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
      };
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      callDoc = doc(db, "calls", `${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`);
      const offerCandidatesCol = collection(callDoc, "offerCandidates");
      const answerCandidatesCol = collection(callDoc, "answerCandidates");

      pc.onicecandidate = (e) => {
        if(e.candidate){
          addDoc(offerCandidatesCol, e.candidate.toJSON());
        }
      };

      const offerDesc = await pc.createOffer();
      await pc.setLocalDescription(offerDesc);
      await setDoc(callDoc, { offer: { type: offerDesc.type, sdp: offerDesc.sdp, from: auth.currentUser.uid, createdAt: Date.now() } });

      onSnapshot(callDoc, (snap) => {
        const data = snap.data();
        if(data && data.answer && pc && !pc.currentRemoteDescription){
          pc.setRemoteDescription(new RTCSessionDescription(data.answer)).catch(console.error);
        }
      });

      onSnapshot(collection(callDoc, "answerCandidates"), (snap) => {
        snap.docChanges().forEach(change => {
          if(change.type === "added"){
            const c = change.doc.data();
            pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error);
          }
        });
      });

      $("callUI").classList.remove("hidden");
      $("callIdField").value = callDoc.id;
      alert("Call created. Share this Call ID with recipient: " + callDoc.id);
    };

    $("joinCallBtn").onclick = async ()=>{
      const id = prompt("Enter Call ID to join:");
      if(!id) return;
      await startLocalAudio();
      pc = new RTCPeerConnection(servers);
      let remoteStream = new MediaStream();
      $("remoteAudio").srcObject = remoteStream;
      pc.ontrack = (event) => {
        event.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
      };
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      callDoc = doc(db, "calls", id);
      const callSnap = await getDoc(callDoc);
      if(!callSnap.exists()){ alert("Call not found"); return; }
      const data = callSnap.data();

      const offerCandidatesCol = collection(callDoc, "offerCandidates");
      onSnapshot(offerCandidatesCol, (snap) => {
        snap.docChanges().forEach(change => {
          if(change.type === "added"){
            pc.addIceCandidate(new RTCIceCandidate(change.doc.data())).catch(console.error);
          }
        });
      });

      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));

      const answerDesc = await pc.createAnswer();
      await pc.setLocalDescription(answerDesc);

      await updateDoc(callDoc, { answer: { type: answerDesc.type, sdp: answerDesc.sdp, from: auth.currentUser.uid, createdAt: Date.now() } });

      pc.onicecandidate = (e) => {
        if(e.candidate){
          addDoc(collection(callDoc, "answerCandidates"), e.candidate.toJSON());
        }
      };

      $("callUI").classList.remove("hidden");
      $("callIdField").value = id;
      alert("Joined call: " + id);
    };

    $("hangupBtn").onclick = async ()=>{
      if(pc){ pc.close(); pc = null; }
      if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; $("localAudio").srcObject = null; }
      $("callUI").classList.add("hidden");
    };

    $("copyCallId").onclick = ()=> { navigator.clipboard.writeText($("callIdField").value || ""); alert("Copied"); };

    // search user by code
    $("btnSearch").onclick = async ()=>{
      const code = normalize($("searchCode").value);
      if(!isValidCode(code)){ $("searchResult").textContent="Invalid code"; return; }
      const snap = await getDoc(doc(db,"userCodes", code));
      if(!snap.exists()){ $("searchResult").textContent="Not found"; return; }
      const d = snap.data();
      $("searchResult").textContent = `Found: ${code} — uid: ${d.uid}`;
    };

    console.log("Oilgram loaded. Make sure private-config.js is available and Firestore rules allow required operations.");
  </script>
</body>
</html>
