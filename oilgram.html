<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Oilgram — Chat & Voice (OIL)</title>
  <style>
    :root{--bg:#fff;--blue:#0b66ff;--muted:#666;--radius:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111;padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.06);margin-bottom:12px}
    input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e9;margin:6px 0;font-size:14px}
    .row{display:flex;gap:8px}
    .btn{background:var(--blue);color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}
    video{width:100%;background:#000;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Oilgram — P2P Voice Calls</h2>
      <p class="small">Login with your Telegram ID (username). On first login choose a code that starts with <strong>666</strong>. Reserved codes (three same digits in a row) are blocked.</p>
    </div>

    <div class="card" id="authCard">
      <div id="authForms">
        <label>Telegram username (example: @yourname)</label>
        <input id="tgUsername" placeholder="@yourname" />
        <label>Choose a password (this will be your login secret)</label>
        <input id="tgPass" placeholder="choose a password" type="password" />
        <label>Choose code (10 digits, start 666) — optional (if blank will be auto-assigned)</label>
        <input id="chosenCode" placeholder="6661234567" />
        <div class="row">
          <button class="btn" id="btnRegister">Register / Login</button>
        </div>
        <div id="authFeedback" class="small"></div>
      </div>

      <div id="profileBox" class="hidden">
        <div><strong id="meId"></strong></div>
        <div class="small" id="meCode"></div>
        <div class="row">
          <button class="btn" id="btnLogout">Logout</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Voice Call</h3>
      <p class="small">Create a call, share the call ID with the other user to join. Peer-to-peer audio; signalling via Firestore.</p>
      <div class="row">
        <button class="btn" id="createCallBtn">Create Call (offer)</button>
        <button class="btn" id="joinCallBtn">Join Call (enter ID)</button>
      </div>

      <div id="callUI" class="hidden" style="margin-top:12px">
        <div style="margin-bottom:8px"><strong>Call ID:</strong> <input id="callIdField" readonly/></div>
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <div class="small">Local (muted preview)</div>
            <video id="localPreview" autoplay muted playsinline style="height:160px"></video>
          </div>
          <div style="flex:1">
            <div class="small">Remote</div>
            <video id="remoteAudioDisplay" autoplay playsinline style="height:160px"></video>
          </div>
        </div>
        <div style="margin-top:8px" class="row">
          <button class="btn" id="hangupBtn">Hang up</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Reserved / Locked Codes</h3>
      <div class="small">Admin can lock or release codes (auction / permanent). Locked patterns: any three identical digits in a row after 666.</div>
      <div id="reservedList" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3>Admin</h3>
      <div class="small">Admin password: <strong>you1378$</strong></div>
      <input id="adminPass" type="password" placeholder="admin password"/>
      <div class="row">
        <button class="btn" id="adminLogin">Open</button>
      </div>
      <div id="adminConsole" class="hidden" style="margin-top:8px">
        <label>Lock code (10 digits)</label>
        <input id="adminLockCode" placeholder="6660000000"/>
        <button class="btn" id="adminLockBtn">Lock code</button>
        <div style="margin-top:8px" class="small">Admin can also release locked codes from Firestore (not fully automated here).</div>
      </div>
    </div>

  </div>

  <!-- private-config.js must set window.__FIREBASE_CONFIG with actual values -->
  <script src="private-config.js"></script>

  <script type="module">
    // ===== Imports =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot,
      serverTimestamp, updateDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ===== Config (from private-config.js) =====
    const firebaseConfig = window.__FIREBASE_CONFIG || {};
    if(!firebaseConfig || !firebaseConfig.projectId){
      alert("Firebase config missing. Add private-config.js with window.__FIREBASE_CONFIG.");
      throw new Error("missing firebase config");
    }
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== Reserved list & helpers =====
    const reserved = new Set([
      "6660000000","6661111111","6662222222","6663333333","6664444444","6665555555","6666666666",
      "6667777777","6668888888","6669999999",
      "6660001111","6660002222","6660003333","6660004444","6660005555","6660006666","6660007777","6660008888","6660009999",
      "6661110000","6662220000","6663330000","6664440000","6665550000","6666660000","6667770000","6668880000","6669990000",
      "6661000000","6662000000","6663000000","6664000000","6665000000","6666000000","6667000000","6668000000","6669000000"
    ]);
    const $ = id => document.getElementById(id);
    const normalize = s => String(s||"").replace(/\D/g,"").slice(0,10);
    const isValidCode = s => /^666\d{7}$/.test(normalize(s));
    const hasTriple = s => /(.)\1\1/.test(normalize(s).slice(3));

    // show reserved list
    function renderReserved(){
      const el = $("reservedList"); el.innerHTML = "";
      Array.from(reserved).forEach(r=>{
        const d = document.createElement('div'); d.textContent = r; el.appendChild(d);
      });
    }
    renderReserved();

    // ===== Simple "Auth" with Telegram username + pass (client-side, saved in Firestore) =====
    // NOTE: real Telegram OAuth requires Telegram widget — recommended later.
    let currentUser = null;
    async function registerOrLogin(){
      const username = ($("tgUsername").value||"").trim();
      const pass = ($("tgPass").value||"").trim();
      let chosen = normalize($("chosenCode").value||"");
      if(!username || !pass){ $("authFeedback").textContent = "Enter Telegram username and a password"; return; }
      // find if user exists
      const userDoc = await getDoc(doc(db,"tgUsers", username));
      if(userDoc.exists()){
        const data = userDoc.data();
        if(data.pass !== pass){ $("authFeedback").textContent = "Wrong password for this username"; return; }
        currentUser = { username, code: data.code, uid: data.uid || username };
        showProfile();
        $("authFeedback").textContent = "Logged in";
        return;
      }
      // create new: choose code
      if(chosen && !isValidCode(chosen)){ $("authFeedback").textContent = "Invalid code format (must start 666)"; return; }
      if(chosen && (reserved.has(chosen) || hasTriple(chosen))){ $("authFeedback").textContent = "Chosen code is reserved"; return; }
      // check uniqueness if chosen
      if(chosen){
        const exists = await getDoc(doc(db,"userCodes", chosen));
        if(exists.exists()){ $("authFeedback").textContent = "Chosen code already taken"; chosen = null; }
      }
      if(!chosen){
        // generate available
        chosen = await generateAvailableCode();
      }
      // save user
      await setDoc(doc(db,"tgUsers", username), { pass, code: chosen, createdAt: serverTimestamp(), username });
      await setDoc(doc(db,"userCodes", chosen), { username, code: chosen, createdAt: serverTimestamp() });
      currentUser = { username, code: chosen, uid: username };
      showProfile();
      $("authFeedback").textContent = "Account created. Your code: " + chosen;
    }

    function showProfile(){
      $("authForms").classList.add('hidden');
      $("profileBox").classList.remove('hidden');
      $("meId").textContent = currentUser.username;
      $("meCode").textContent = "Code: " + currentUser.code;
    }
    $("btnRegister").onclick = registerOrLogin;
    $("btnLogout").onclick = ()=>{ location.reload(); };

    async function generateAvailableCode(){
      for(let i=0;i<200;i++){
        const r = "666" + String(Math.floor(Math.random()*9000000)+1000000);
        if(reserved.has(r)) continue;
        const s = await getDoc(doc(db,"userCodes", r));
        if(!s.exists()) return r;
      }
      // fallback quick scan
      for(let i=0;i<1000000;i++){
        const r = "666" + String(i).padStart(7,"0");
        if(reserved.has(r)) continue;
        const s = await getDoc(doc(db,"userCodes", r));
        if(!s.exists()) return r;
      }
      throw new Error("No code");
    }

    // ===== Admin =====
    $("adminLogin").onclick = ()=>{
      const p = $("adminPass").value;
      if(p === "you1378$"){ $("adminConsole").classList.remove('hidden'); alert("Admin enabled"); }
      else alert("Wrong password");
    };
    $("adminLockBtn").onclick = async ()=>{
      const c = normalize($("adminLockCode").value);
      if(!isValidCode(c)){ alert("Invalid code"); return; }
      reserved.add(c); await setDoc(doc(db,"auctions", c), { code:c, locked:true, createdAt: serverTimestamp() });
      renderReserved(); alert("Locked for auction (client-side recorded).");
    };

    // ===== WebRTC voice call (simple calls collection) =====
    let pc = null, localStream = null, remoteStream = null, callDoc = null;
    const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    async function startLocalAudio(){
      if(localStream) return;
      try{
        localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
        const audioEl = document.getElementById('localPreview');
        audioEl.srcObject = localStream;
      } catch(e){ alert("Mic access denied: " + e.message); throw e; }
    }

    $("createCallBtn").onclick = async ()=>{
      if(!currentUser){ alert("Login first"); return; }
      await startLocalAudio();
      pc = new RTCPeerConnection(servers);
      remoteStream = new MediaStream();
      document.getElementById('remoteAudioDisplay').srcObject = remoteStream;
      pc.ontrack = e => { e.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t)); };
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.onicecandidate = async event => {
        if(event.candidate && callDoc){
          await addDoc(collection(callDoc, "offerCandidates"), event.candidate.toJSON());
        }
      };

      // create call doc
      callDoc = doc(collection(db,"calls"));
      const offerDesc = await pc.createOffer();
      await pc.setLocalDescription(offerDesc);
      await setDoc(callDoc, { offer: { type: offerDesc.type, sdp: offerDesc.sdp, from: currentUser.uid }, createdAt: serverTimestamp() });

      // listen for answer and candidates
      onSnapshot(callDoc, snap=>{
        const data = snap.data();
        if(data?.answer && pc && !pc.currentRemoteDescription){
          pc.setRemoteDescription(new RTCSessionDescription(data.answer)).catch(console.error);
        }
      });

      const answerCandidates = collection(callDoc, "answerCandidates");
      onSnapshot(answerCandidates, snap=>{
        snap.docChanges().forEach(ch=>{
          if(ch.type === "added") pc.addIceCandidate(new RTCIceCandidate(ch.doc.data())).catch(console.error);
        });
      });

      // share id
      $("callUI").classList.remove('hidden');
      $("callIdField").value = callDoc.id;
      alert("Call created. Share this ID with other user: " + callDoc.id);
    };

    $("joinCallBtn").onclick = async ()=>{
      const id = prompt("Enter call ID:");
      if(!id) return;
      await startLocalAudio();
      pc = new RTCPeerConnection(servers);
      remoteStream = new MediaStream();
      document.getElementById('remoteAudioDisplay').srcObject = remoteStream;
      pc.ontrack = e=> { e.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t)); };
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      callDoc = doc(db,"calls", id);
      const callSnapshot = await getDoc(callDoc);
      if(!callSnapshot.exists()){ alert("Call not found"); return; }
      const data = callSnapshot.data();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answerDesc = await pc.createAnswer();
      await pc.setLocalDescription(answerDesc);
      await updateDoc(callDoc, { answer: { type: answerDesc.type, sdp: answerDesc.sdp, from: currentUser.uid } });

      // add listeners to candidates
      const offerCandidates = collection(callDoc, "offerCandidates");
      onSnapshot(offerCandidates, snap=>{
        snap.docChanges().forEach(ch=>{
          if(ch.type==="added") pc.addIceCandidate(new RTCIceCandidate(ch.doc.data())).catch(console.error);
        });
      });

      pc.onicecandidate = e=>{
        if(e.candidate) addDoc(collection(callDoc, "answerCandidates"), e.candidate.toJSON());
      };

      $("callUI").classList.remove('hidden');
      $("callIdField").value = id;
      alert("Joined call");
    };

    $("hangupBtn").onclick = async ()=>{
      if(pc){ pc.close(); pc = null; }
      if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; document.getElementById('localPreview').srcObject = null; }
      $("callUI").classList.add('hidden');
      callDoc = null;
    };

    // small aliases
    import { addDoc as addDocFn, collection as collectionFn, doc as docFn, getDoc as getDocFn, setDoc as setDocFn, serverTimestamp as serverTimestampFn, updateDoc as updateDocFn } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    // but we already imported above; leaving as-is.

    // helper: escape
    function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // Note: For production, replace simple username+pass with Telegram Login Widget or real OAuth.
    console.log("Oilgram loaded. Ensure private-config.js contains firebase config and Firestore rules / TTL are set.");
  </script>
</body>
  </html>
