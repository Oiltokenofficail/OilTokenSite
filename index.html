<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OILToken — Official Site</title>
  <style>
    :root{
      --bg: #ffffff;
      --accent: linear-gradient(135deg,#009dff,#7f00ff);
      --gold: linear-gradient(135deg,#ffd700,#ff6a00);
      --card-radius:16px;
      --gap:14px;
      --muted:#666;
    }
    *{box-sizing:border-box}
    body{font-family:Poppins,system-ui,Arial; margin:0; background:var(--bg); color:#111; -webkit-font-smoothing:antialiased}
    .wrap{max-width:1200px;margin:18px auto;padding:20px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .brand{flex:1;min-width:260px}
    .brand h1{margin:0;color:#111;font-size:26px}
    .brand p{margin:6px 0 0;color:var(--muted)}
    nav.top-nav{display:flex;gap:10px;flex-wrap:wrap}
    nav.top-nav a{padding:8px 12px;border-radius:10px;text-decoration:none;color:#fff;font-weight:700;background:linear-gradient(135deg,#ff416c,#ff7b00);box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .hero{margin-top:18px;border-radius:16px;padding:22px;background:linear-gradient(135deg,#ffffff,#f7fbff);box-shadow:0 10px 30px rgba(11,18,32,0.04)}
    .hero h2{margin:0 0 8px}
    .hero p{margin:0;color:#333}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
    .section-title{font-weight:800;margin-bottom:8px}
    .sub{color:var(--muted);font-size:13px}
    .big-cta{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:12px;background:linear-gradient(90deg,#00c6ff,#0072ff);color:#fff;text-decoration:none;font-weight:800}
    .link-list{display:flex;flex-direction:column;gap:8px}
    .link-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(135deg,#fff,#f5f7ff);border:1px solid #eee}
    .link-item a{color:#111;text-decoration:none;font-weight:700}
    .contacts{font-size:14px}
    iframe#oilgram-iframe{width:100%;height:640px;border-radius:12px;border:1px solid #eee}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px;padding:18px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} iframe#oilgram-iframe{height:560px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Welcome to OILToken</h1>
        <p>The future of decentralized oil-backed digital assets — modernizing the oil market with blockchain.</p>
      </div>

      <nav class="top-nav" aria-label="Explore">
        <a href="WhitePaper.html" target="_blank">WhitePaper</a>
        <a href="Roadmap.html" target="_blank">Roadmap</a>
        <a href="Tokenomics.html" target="_blank">Tokenomics</a>
        <a href="Team.html" target="_blank">Team</a>
        <a href="Description.html" target="_blank">Description</a>
        <a href="https://oiltokenofficail.github.io/OilTokenSite/oilgram.html" target="_blank" style="background:linear-gradient(135deg,#00b09b,#96c93d)">Oilgram</a>
      </nav>
    </header>

    <section class="hero">
      <h2>OILToken — Digital energy, reimagined</h2>
      <p>OILToken is a unique digital asset aiming to bring the global oil market into a transparent, tradable, and decentralized framework. Join holders and early supporters today.</p>
    </section>

    <div style="margin-top:18px" class="card">
      <div class="section-title">Explore — Quick Links</div>
      <div class="link-list">
        <div class="link-item">
          <a href="https://oilprice.com/" target="_blank">Oil Market News (live)</a>
          <span class="sub">oilprice.com</span>
        </div>
        <div class="link-item">
          <a href="https://coinmarketcap.com/" target="_blank">Crypto Live — CoinMarketCap</a>
          <span class="sub">coinmarketcap.com</span>
        </div>
        <div class="link-item">
          <a href="https://www.coingecko.com/" target="_blank">Crypto Live — CoinGecko</a>
          <span class="sub">coingecko.com</span>
        </div>
        <div class="link-item">
          <a href="https://www.bloomberg.com/live" target="_blank">Bloomberg TV</a>
          <span class="sub">bloomberg.com</span>
        </div>
        <div class="link-item">
          <a href="https://app.ston.fi/swap" target="_blank">STON.fi (swap / pool)</a>
          <span class="sub">STON.fi</span>
        </div>
        <div class="link-item contacts">
          <div>
            <strong>Connect with us</strong><br/>
            Telegram: <a href="https://t.me/oilofficial" target="_blank">t.me/oilofficial</a> — Email: <a href="mailto:oiltokenofficial@gmail.com">oiltokenofficial@gmail.com</a>
          </div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:18px">
      <div>
        <!-- Place for any future content / news -->
        <div class="card">
          <div class="section-title">Latest Announcement</div>
          <div class="sub">Multi-chain expansion — OILToken will soon be available on Ethereum and BSC, in addition to TON. Follow official channels for launch details.</div>
        </div>

        <!-- Oilgram section: embedded iframe -->
        <div style="margin-top:18px">
          <div class="card">
            <div class="section-title">Oilgram — Chat & Calls (embedded)</div>
            <div class="sub">Oilgram is embedded below. If you uploaded <code>oilgram.html</code> to the same folder on GitHub Pages, it will load here. Otherwise click the Open button to open in a new tab.</div>
            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
              <a class="big-cta" href="https://oiltokenofficail.github.io/OilTokenSite/oilgram.html" target="_blank">Open Oilgram (new tab)</a>
              <button class="big-cta" style="background:linear-gradient(90deg,#00b09b,#00ffcc)" onclick="reloadIframe()">Reload embed</button>
            </div>

            <div style="margin-top:12px">
              <!-- IFRAME: will show oilgram.html if present in same repo root -->
              <iframe id="oilgram-iframe" src="oilgram.html" title="Oilgram chat"></iframe>
            </div>

            <div style="margin-top:8px" class="small">
              Notes:
              <ul>
                <li>For chat & calls to work you must upload <code>oilgram.html</code> and its scripts to the same GitHub Pages site (same folder).</li>
                <li>Make sure Firebase configuration is provided securely to <code>oilgram.html</code> (see instructions below).</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <div class="section-title">Reserved Codes (examples)</div>
          <div class="sub">Numbers starting with <strong>666</strong> where three (or more) identical digits appear consecutively after the prefix are reserved for auction.</div>
          <div style="margin-top:8px" class="small">
            Examples: 6660000000 • 6661111111 • 6665550000 • 6667777000
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="section-title">Admin</div>
          <div class="small">Admin UI & moderation live inside Oilgram (client demo). For secure admin actions use server-side tools.</div>
        </div>
      </aside>
    </div>

    <footer>
      © <strong>OILToken Team</strong> — official channels: <a href="https://t.me/oilofficial" target="_blank">Telegram</a> • Email: <a href="mailto:oiltokenofficial@gmail.com">oiltokenofficial@gmail.com</a>
    </footer>
  </div>

  <script>
    // Helper to reload the embedded oilgram iframe (useful after you upload oilgram.html)
    function reloadIframe(){
      const iframe = document.getElementById('oilgram-iframe');
      iframe.src = iframe.src.split('#')[0] + '#reload-' + Date.now();
    }

    // Security note shown in console (not exposing any secret here)
    console.log('Index loaded. Make sure oilgram.html has Firebase config securely provided (see README).');
  </script>

  <!--
    IMPORTANT: Protecting Firebase config
    ------------------------------------
    - This index.html intentionally does NOT include any Firebase keys.
    - Provide Firebase config only inside oilgram.html or a separate JS file that you DO NOT commit publicly.
      Example: create a file named `private-config.js` (locally) which contains:
        window.__FIREBASE_CONFIG = { apiKey: "...", authDomain: "...", projectId: "...", ... };
      Then in oilgram.html load that file BEFORE any Firebase SDK code:
        <script src="private-config.js"></script>
        <script type="module" src="oilgram-main.js"></script>
      IMPORTANT: Do NOT push private-config.js to a public GitHub repository.
    - For production consider using Firebase Hosting or a server to serve config from an environment-protected endpoint.
  -->
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oil Token — OIL / Oilgram (Chat & Calls)</title>
  <style>
    :root{
      --bg:#ffffff;
      --accent:#6a0dad;
      --accent2:#ffd700;
      --radius:12px;
      --muted:#666;
      --success:#16a34a;
      --danger:#e11d48;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial; margin:0; background:var(--bg); color:#111;}
    .wrap{max-width:1200px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .card{background:#fff;border-radius:var(--radius);padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
    label{display:block;margin:8px 0 6px;font-weight:600}
    input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e9;margin:6px 0;font-size:14px}
    .row{display:flex;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    .messages{height:340px;overflow:auto;padding:10px;border-radius:10px;background:#f7f8fa;border:1px solid #eee}
    .msg{padding:8px;border-radius:8px;margin-bottom:8px;background:#fff;border:1px solid #eee}
    .mine{background:#e6ffe9}
    .small{font-size:12px;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid #eee}
    .hidden{display:none}
    .reserved{color:var(--danger);font-weight:700}
    .top-nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .top-nav a{padding:8px 12px;border-radius:8px;background:linear-gradient(135deg,#ff6a00,#ffd700);color:#111;text-decoration:none;font-weight:700}
    .note{background:#f0f8ff;padding:10px;border-radius:8px;margin:10px 0}
    @media(max-width:930px){ .grid{grid-template-columns:1fr} .messages{height:240px} }
    video, audio{max-width:100%;border-radius:8px}
    .call-area{display:flex;gap:8px;flex-wrap:wrap}
    .inline{display:inline-block;width:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>OILToken — Oilgram (Chat & Calls)</h1>
        <div class="small">Email/password auth • Unique codes start with <strong>666</strong></div>
      </div>
      <div class="top-nav">
        <a href="WhitePaper.html">WhitePaper</a>
        <a href="Roadmap.html">Roadmap</a>
        <a href="Tokenomics.html">Tokenomics</a>
        <a href="Team.html">Team</a>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Chat & Calls -->
      <div>
        <!-- Auth / profile -->
        <div class="card" id="authCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Sign up / Login</div>
              <div class="small">Create account with email & password. After signup assign a 10-digit code starting with <strong>666</strong>.</div>
            </div>
            <div id="profileBox" class="hidden">
              <div id="meEmail" style="font-weight:700"></div>
              <div id="meCode" class="small"></div>
              <button class="btn ghost inline" id="btn-logout">Logout</button>
            </div>
          </div>

          <div id="authForms">
            <div id="signup">
              <label>Email</label><input id="su-email" type="email" placeholder="you@example.com" />
              <label>Password</label><input id="su-pass" type="password" placeholder="min 6 chars" />
              <label>Choose code (optional; 10 digits, start 666)</label><input id="su-code" placeholder="6661234567 or leave blank" />
              <div class="row">
                <button class="btn" id="btn-signup">Sign Up</button>
                <button class="btn ghost" id="btn-show-login">Go to Login</button>
              </div>
            </div>

            <div id="login" class="hidden">
              <label>Email</label><input id="li-email" type="email" />
              <label>Password</label><input id="li-pass" type="password" />
              <div class="row">
                <button class="btn" id="btn-login">Login</button>
                <button class="btn ghost" id="btn-show-signup">Back to Sign Up</button>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Assign / Reserve Number</label>
              <input id="chosenNumber" placeholder="6661234567" />
              <div id="numberNotice" class="small muted">Numbers with 3 or more identical digits in a row after 666 are reserved for auction.</div>
              <div class="row">
                <button class="btn" id="btn-check-number">Check Availability</button>
                <button class="btn ghost" id="btn-assign-number">Reserve / Assign</button>
              </div>
              <div id="numberFeedback" class="small" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <!-- Public chat -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Public Chat</strong><div class="small">Visible to all authenticated users</div></div>
            <div>
              <button class="btn ghost" id="openPublic">Open</button>
            </div>
          </div>

          <div id="publicSection" class="hidden" style="margin-top:10px">
            <div class="messages" id="publicMessages"></div>
            <div class="row" style="margin-top:8px">
              <input id="publicInput" placeholder="Write public message..." />
              <button class="btn" id="publicSend">Send</button>
            </div>
          </div>
        </div>

        <!-- Private chat -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Private Chat</strong><div class="small">Search by user code (666...)</div></div>
            <div><button class="btn ghost" id="openPrivate">Open</button></div>
          </div>

          <div id="privateSection" class="hidden" style="margin-top:10px">
            <label>Recipient code</label>
            <input id="privateRecipientCode" placeholder="6661234567" />
            <div class="row">
              <button class="btn" id="startPrivate">Start Private Chat</button>
            </div>

            <div id="privateArea" class="hidden" style="margin-top:8px">
              <div class="small">Chat with: <span id="privateWith"></span></div>
              <div class="messages" id="privateMessages"></div>
              <div class="row">
                <input id="privateInput" placeholder="Write private message..." />
                <button class="btn" id="privateSend">Send</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Calls -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Voice & Video Calls (1:1)</strong><div class="small">WebRTC using Firestore as signalling. HTTPS required.</div></div>
          </div>

          <div style="margin-top:10px">
            <div class="small">Start a new call (you create an offer) or join by call ID.</div>
            <div style="margin-top:8px" class="row">
              <button class="btn" id="btn-create-call">Create Call (Offer)</button>
              <button class="btn ghost" id="btn-join-call">Join Call (Enter ID)</button>
            </div>

            <div id="callArea" class="hidden" style="margin-top:10px">
              <div class="row">
                <div style="flex:1">
                  <div class="small">Local</div>
                  <video id="localVideo" autoplay playsinline muted style="width:100%;height:180px;background:#000;border-radius:8px"></video>
                </div>
                <div style="flex:1">
                  <div class="small">Remote</div>
                  <video id="remoteVideo" autoplay playsinline style="width:100%;height:180px;background:#000;border-radius:8px"></video>
                </div>
              </div>
              <div style="margin-top:8px" class="row">
                <input id="callIdInput" placeholder="Call ID (if joining)"/>
                <button class="btn" id="btnCopyCallId">Copy ID</button>
              </div>
              <div style="margin-top:6px" class="row">
                <button class="btn ghost" id="btnHangup">Hang Up</button>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT: Utilities / Admin / Reserved -->
      <div>
        <div class="card">
          <div style="font-weight:800">Quick Info</div>
          <div class="small" style="margin-top:8px">Reserved numbers (examples) will not be auto-assigned; they are locked for auction.</div>
          <div style="margin-top:8px" id="reservedList"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:800">Admin (local)</div>
          <div class="small">Client-side admin for moderation (demo). For production use server-side admin.</div>
          <label>Admin password</label>
          <input id="adminPass" type="password" placeholder="admin password" />
          <div class="row">
            <button class="btn" id="adminLogin">Open Admin</button>
            <button class="btn ghost" id="adminLogout">Close</button>
          </div>
          <div id="adminConsole" class="hidden" style="margin-top:8px">
            <label>Lock code (for auction)</label>
            <input id="adminLockCode" placeholder="6660000000" />
            <button class="btn" id="adminLock">Lock Code</button>
            <div style="margin-top:8px" class="small">Admin can also delete messages in UI.</div>
          </div>
          <div id="adminStatus" class="small" style="margin-top:8px;color:var(--danger)"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:800">Search user by code</div>
          <input id="searchCode" placeholder="6661234567" />
          <button class="btn" id="btnSearch">Find</button>
          <div id="searchResult" class="small" style="margin-top:8px"></div>
        </div>

      </div>
    </div>

  </div>

  <!-- ========== Firebase + App logic ========== -->
  <script type="module">
    /**
     * IMPORTANT:
     * Replace the FIREBASE CONFIG BELOW with your Firebase project's config object.
     * Do NOT commit your real keys to a public repo if you can't rotate them.
     *
     * Example (paste your actual values):
     * const firebaseConfig = {
     *   apiKey: "YOUR_API_KEY",
     *   authDomain: "your-project.firebaseapp.com",
     *   projectId: "your-project",
     *   storageBucket: "your-project.appspot.com",
     *   messagingSenderId: "...",
     *   appId: "1:...:web:..."
     * };
     */

    // ---------- IMPORTS ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot,
      query, where, serverTimestamp, orderBy, getDocs, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // ---------- PUT YOUR FIREBASE CONFIG HERE ----------
    const firebaseConfig = /* PASTE YOUR FIREBASE CONFIG OBJECT HERE */ {};

    if (!firebaseConfig || Object.keys(firebaseConfig).length===0) {
      console.error("Firebase config is empty. Please paste your firebaseConfig into the file.");
      alert("Firebase configuration missing. Open this file and paste your firebaseConfig.");
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- Constants & reserved lists ----------
    const ADMIN_PASSWORD = "Oilcoin1378"; // per your request
    const reservedNumbers = new Set([
      "6660000000","6661111111","6662222222","6663333333","6664444444","6665555555","6666666666",
      "6667777777","6668888888","6669999999",
      "6660001111","6660002222","6660003333","6660004444","6660005555","6660006666","6660007777","6660008888","6660009999",
      "6661110000","6662220000","6663330000","6664440000","6665550000","6666660000","6667770000","6668880000","6669990000",
      "6661000000","6662000000","6663000000","6664000000","6665000000","6666000000","6667000000","6668000000","6669000000"
    ]);

    // ---------- Helpers ----------
    const $ = id => document.getElementById(id);
    const normalize = s => String(s||"").replace(/\D/g,"").slice(0,10);
    const isValidCode = s => /^666\d{7}$/.test(normalize(s));
    const hasTripleIdentical = s => {
      const tail = normalize(s).slice(3);
      return /(.)\1\1/.test(tail);
    };

    // ---------- UI wiring ----------
    $("btn-show-login").onclick = ()=>{ $("signup").classList.add('hidden'); $("login").classList.remove('hidden'); }
    $("btn-show-signup").onclick = ()=>{ $("signup").classList.remove('hidden'); $("login").classList.add('hidden'); }

    // --------- Reserved list UI ----------
    async function renderReserved(){
      const el = $("reservedList"); el.innerHTML = "";
      for (const code of reservedNumbers) {
        const div = document.createElement("div");
        div.className = "small";
        div.innerHTML = `<strong class="reserved">${code}</strong>`;
        el.appendChild(div);
      }
    }
    renderReserved();

    // ---------- Auth flows ----------
    $("btn-signup").onclick = async ()=>{
      const email = $("su-email").value.trim();
      const pass = $("su-pass").value;
      const chosen = normalize($("su-code").value);
      if(!email || !pass || pass.length<6){ alert("Enter valid email and password (min 6 chars)"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = cred.user.uid;
        // choose code
        let final = null;
        if(chosen && isValidCode(chosen) && !reservedNumbers.has(chosen)){
          // check uniqueness
          const q = query(collection(db,"userCodes"), where("code","==", chosen));
          const snap = await getDocs(q);
          if(snap.empty) final = chosen;
        }
        if(!final){
          final = await generateAvailableCode();
        }
        // save docs
        await setDoc(doc(db,"users", uid), { email, code: final, createdAt: serverTimestamp() });
        await setDoc(doc(db,"userCodes", final), { uid, code: final, createdAt: serverTimestamp() });
        alert("Account created. Your code: " + final);
      }catch(e){
        console.error(e); alert("Sign up error: " + (e.message||e));
      }
    };

    $("btn-login").onclick = async ()=>{
      const email = $("li-email").value.trim();
      const pass = $("li-pass").value;
      if(!email || !pass) { alert("Enter email and password"); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(e){ console.error(e); alert("Login error: " + (e.message||e)); }
    };

    $("btn-logout").onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async user=>{
      if(user){
        $("profileBox").classList.remove('hidden');
        $("authForms").classList.add('hidden');
        $("btn-logout").style.display = 'inline-block';
        const ud = await getDoc(doc(db,"users", user.uid));
        const docData = ud.exists() ? ud.data() : null;
        $("meEmail").textContent = user.email;
        $("meCode").textContent = docData?.code ? "Code: " + docData.code : "Code: not assigned";
        // start listeners
        startPublicListener();
      } else {
        $("profileBox").classList.add('hidden');
        $("authForms").classList.remove('hidden');
        $("btn-logout").style.display = 'none';
        stopPublicListener();
      }
    });

    // ---------- Code assignment ----------
    async function generateAvailableCode(){
      // try random attempts
      for(let i=0;i<50;i++){
        const r = "666" + String(Math.floor(Math.random()*9000000)+1000000).padStart(7,'0');
        if(reservedNumbers.has(r)) continue;
        const snap = await getDoc(doc(db,"userCodes", r));
        if(!snap.exists()) return r;
      }
      // fallback linear scan (could be slow)
      for(let i=0;i<1000000;i++){
        const r = "666" + String(i).padStart(7,'0');
        if(reservedNumbers.has(r)) continue;
        const snap = await getDoc(doc(db,"userCodes", r));
        if(!snap.exists()) return r;
      }
      throw new Error("No codes available");
    }

    $("btn-check-number").onclick = async ()=>{
      const raw = normalize($("chosenNumber").value);
      if(!isValidCode(raw)){ $("numberFeedback").textContent = "Format invalid. Must be 10 digits starting 666."; $("numberFeedback").style.color = "red"; return;}
      if(reservedNumbers.has(raw) || hasTripleIdentical(raw)){ $("numberFeedback").textContent = "Reserved for auction."; $("numberFeedback").style.color="red"; return; }
      const snap = await getDoc(doc(db,"userCodes", raw));
      if(snap.exists()){ $("numberFeedback").textContent = "Taken."; $("numberFeedback").style.color="red"; return; }
      $("numberFeedback").textContent = "Available ✅"; $("numberFeedback").style.color = "green";
    };

    $("btn-assign-number").onclick = async ()=>{
      const user = auth.currentUser;
      if(!user){ alert("Login first"); return; }
      const raw = normalize($("chosenNumber").value);
      if(!isValidCode(raw)){ $("numberFeedback").textContent = "Format invalid."; $("numberFeedback").style.color="red"; return; }
      if(reservedNumbers.has(raw) || hasTripleIdentical(raw)){ $("numberFeedback").textContent = "Reserved for auction."; $("numberFeedback").style.color="red"; return; }
      const taken = await getDoc(doc(db,"userCodes", raw));
      if(taken.exists()){ $("numberFeedback").textContent = "Taken."; $("numberFeedback").style.color="red"; return; }
      await setDoc(doc(db,"userCodes", raw), { uid: user.uid, code: raw, createdAt: serverTimestamp() });
      await updateDoc(doc(db,"users", user.uid), { code: raw, assignedAt: serverTimestamp() });
      $("numberFeedback").textContent = "Assigned ✅"; $("numberFeedback").style.color="green";
    };

    // ---------- Public chat (Firestore collection: publicMessages) ----------
    let publicUnsub = null;
    function startPublicListener(){
      const col = collection(db,"publicMessages");
      if(publicUnsub) publicUnsub();
      const q = query(col, orderBy("createdAt","desc"));
      publicUnsub = onSnapshot(q, snap=>{
        const list = $("publicMessages"); list.innerHTML = "";
        const docs = snap.docs.slice().reverse();
        docs.forEach(d=>{
          const v = d.data();
          const div = document.createElement("div");
          div.className = "msg" + (v.uid===auth.currentUser?.uid ? " mine": "");
          div.innerHTML = `<div class="small">${escapeHtml(v.code||v.email||"")}</div><div>${escapeHtml(v.text)}</div>`;
          if(window._adminLogged) {
            const del = document.createElement("button");
            del.textContent = "Delete"; del.className="btn ghost inline";
            del.onclick = async ()=> { if(confirm("Delete?")) await deleteDoc(doc(db,"publicMessages", d.id)); };
            div.appendChild(del);
          }
          list.appendChild(div);
        });
        list.scrollTop = list.scrollHeight;
      });
    }
    function stopPublicListener(){ if(publicUnsub) publicUnsub(); $("publicMessages").innerHTML=""; }

    $("publicSend").onclick = async ()=>{
      const txt = $("publicInput").value.trim(); if(!txt) return;
      if(!auth.currentUser){ alert("Login to send"); return; }
      const ud = await getDoc(doc(db,"users", auth.currentUser.uid));
      await addDoc(collection(db,"publicMessages"), { uid: auth.currentUser.uid, email: auth.currentUser.email, code: ud.data()?.code||null, text: txt, createdAt: serverTimestamp() });
      $("publicInput").value = "";
    };

    $("openPublic").onclick = ()=> $("publicSection").classList.toggle('hidden');

    // ---------- Private chat ----------
    let currentPrivateConvoId = null;
    let privateUnsub = null;

    $("startPrivate").onclick = async ()=>{
      const code = normalize($("privateRecipientCode").value);
      if(!isValidCode(code)){ alert("Enter valid code"); return; }
      // find target UID
      const targetSnap = await getDoc(doc(db,"userCodes", code));
      if(!targetSnap.exists()){ alert("User not found"); return; }
      const target = targetSnap.data();
      if(target.uid === auth.currentUser.uid){ alert("Cannot chat with yourself"); return; }
      // deterministic convo id
      const convo = [auth.currentUser.uid, target.uid].sort().join("_");
      currentPrivateConvoId = convo;
      $("privateWith").textContent = code;
      $("privateArea").classList.remove('hidden');
      // setup listener
      if(privateUnsub) privateUnsub();
      const q = query(collection(db,"privateMessages"), where("convoId","==", convo), orderBy("createdAt","desc"));
      privateUnsub = onSnapshot(q, snap=>{
        const list = $("privateMessages"); list.innerHTML = "";
        snap.docs.slice().reverse().forEach(d=>{
          const v = d.data();
          const div = document.createElement("div");
          div.className = "msg" + (v.uid===auth.currentUser?.uid ? " mine": "");
          div.innerHTML = `<div class="small">${escapeHtml(v.code||v.email||"")}</div><div>${escapeHtml(v.text)}</div>`;
          if(window._adminLogged){
            const del = document.createElement("button");
            del.textContent="Delete"; del.className="btn ghost inline";
            del.onclick = async ()=>{ if(confirm("Delete?")) await deleteDoc(doc(db,"privateMessages", d.id)); };
            div.appendChild(del);
          }
          list.appendChild(div);
        });
        list.scrollTop = list.scrollHeight;
      });
    };

    $("privateSend").onclick = async ()=>{
      const txt = $("privateInput").value.trim(); if(!txt) return;
      if(!currentPrivateConvoId){ alert("Open private chat"); return; }
      const ud = await getDoc(doc(db,"users", auth.currentUser.uid));
      await addDoc(collection(db,"privateMessages"), { convoId: currentPrivateConvoId, uid: auth.currentUser.uid, email: auth.currentUser.email, code: ud.data()?.code||null, text: txt, createdAt: serverTimestamp() });
      $("privateInput").value = "";
    };

    $("openPrivate").onclick = ()=> $("privateSection").classList.toggle('hidden');

    // ---------- Admin client toggle ----------
    window._adminLogged = false;
    $("adminLogin").onclick = ()=>{
      const p = $("adminPass").value;
      if(p === ADMIN_PASSWORD) { window._adminLogged = true; $("adminConsole").classList.remove('hidden'); $("adminStatus").textContent = "Admin enabled (client-side)"; }
      else alert("Wrong admin password");
    };
    $("adminLogout").onclick = ()=> { window._adminLogged = false; $("adminConsole").classList.add('hidden'); $("adminStatus").textContent = ""; };

    $("adminLock").onclick = async ()=>{
      const code = normalize($("adminLockCode").value);
      if(!isValidCode(code)) return alert("Enter valid 10-digit code");
      reservedNumbers.add(code);
      // store a record in Firestore for admin auditing
      await setDoc(doc(db,"auctions", code), { code, locked: true, createdAt: serverTimestamp()});
      await renderReserved();
      alert("Locked for auction (client record). Implement full auction server-side.");
    };

    // ---------- Search ----------
    $("btnSearch").onclick = async ()=>{
      const code = normalize($("searchCode").value);
      if(!isValidCode(code)) return $("searchResult").innerHTML = "Invalid code";
      const snap = await getDoc(doc(db,"userCodes", code));
      if(!snap.exists()) return $("searchResult").innerHTML = "Not found";
      const d = snap.data();
      $("searchResult").innerHTML = `Found: ${escapeHtml(code)} — uid: ${escapeHtml(d.uid)}`;
    };

    // ---------- Utilities ----------
    function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ---------- WebRTC call setup using Firestore signalling ----------
    // Simple 1:1 call implementation: create call doc with offer/answer and ICE candidate subcollections.
    let pc = null;
    let localStream = null;
    let remoteStream = null;
    let callDocRef = null;
    const servers = { iceServers: [{urls: "stun:stun.l.google.com:19302"}] };

    $("btn-create-call").onclick = async ()=>{
      await startLocalStream();
      pc = new RTCPeerConnection(servers);
      setupPcHandlers(pc);

      // add local tracks
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // create call doc
      callDocRef = doc(collection(db,"calls"));
      const offerCandidates = collection(callDocRef, "offerCandidates");
      const answerCandidates = collection(callDocRef, "answerCandidates");

      // collect ICE candidates and push to Firestore
      pc.onicecandidate = event => {
        if(event.candidate){
          addDoc(offerCandidates, event.candidate.toJSON());
        }
      };

      // create offer
      const offerDescription = await pc.createOffer();
      await pc.setLocalDescription(offerDescription);

      const offer = { type: offerDescription.type, sdp: offerDescription.sdp, createdAt: serverTimestamp() };
      await setDoc(callDocRef, { offer });

      // listen for answer
      onSnapshot(callDocRef, snap=>{
        const data = snap.data();
        if(!pc.currentRemoteDescription && data?.answer){
          const answerDesc = new RTCSessionDescription(data.answer);
          pc.setRemoteDescription(answerDesc).catch(console.error);
        }
      });

      // listen for answer ICE candidates
      onSnapshot(answerCandidates, snap=>{
        snap.docChanges().forEach(change=>{
          if(change.type === "added"){
            const c = change.doc.data();
            pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error);
          }
        });
      });

      // show call id to share
      $("callArea").classList.remove('hidden');
      $("callIdInput").value = callDocRef.id;
      alert("Call created. Share Call ID: " + callDocRef.id);
    };

    $("btn-join-call").onclick = async ()=>{
      const id = prompt("Enter Call ID to join:");
      if(!id) return;
      await startLocalStream();
      pc = new RTCPeerConnection(servers);
      setupPcHandlers(pc);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      callDocRef = doc(db,"calls", id);
      const callSnap = await getDoc(callDocRef);
      if(!callSnap.exists()){ alert("Call not found"); return; }
      const data = callSnap.data();

      // add offerCandidates listener
      const offerCandidates = collection(callDocRef, "offerCandidates");
      const answerCandidates = collection(callDocRef, "answerCandidates");

      // add remote ICE from offer side
      onSnapshot(offerCandidates, snap=>{
        snap.docChanges().forEach(change=>{
          if(change.type === "added"){
            const c = change.doc.data();
            pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error);
          }
        });
      });

      // set remote description (offer)
      const offerDesc = data.offer;
      await pc.setRemoteDescription(new RTCSessionDescription(offerDesc));

      // create answer
      const answerDesc = await pc.createAnswer();
      await pc.setLocalDescription(answerDesc);

      // save answer
      await updateDoc(callDocRef, { answer: { type: answerDesc.type, sdp: answerDesc.sdp } });

      // collect local ICE and write to answerCandidates
      pc.onicecandidate = event => {
        if(event.candidate){
          addDoc(answerCandidates, event.candidate.toJSON());
        }
      };

      $("callArea").classList.remove('hidden');
      $("callIdInput").value = id;
      alert("Joined call: " + id);
    };

    function setupPcHandlers(pcInstance){
      remoteStream = new MediaStream();
      $("remoteVideo").srcObject = remoteStream;
      pcInstance.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
      };
      pcInstance.onconnectionstatechange = ()=> {
        if(pcInstance.connectionState === "connected") {
          console.log("Peers connected!");
        }
      };
    }

    async function startLocalStream(){
      if(localStream) return;
      try{
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        $("localVideo").srcObject = localStream;
      } catch(e){
        console.error(e); alert("Could not get camera/microphone: " + e.message);
      }
    }

    $("btnHangup").onclick = async ()=>{
      if(pc){ pc.close(); pc = null; }
      if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; $("localVideo").srcObject = null; }
      $("callArea").classList.add('hidden');
      // if created a call doc, optionally delete it (careful)
      if(callDocRef){
        // delete subcollections and doc (not implemented fully here)
        // For safety we keep it. Implement server-side cleanup if desired.
        callDocRef = null;
      }
    };

    $("btnCopyCallId").onclick = ()=> { navigator.clipboard.writeText($("callIdInput").value); alert("Copied"); };

    // ---------- small helpers ----------
    function addDoc(colRef, data){ return addDoc(colRef, data); } // alias to avoid name conflict earlier
    // note: we used addDoc (imported) already above; keep compatibility

    // ---------- initial UI bindings ----------
    window.addEventListener('load', ()=> {
      // nothing additional
    });

  </script>
</body>
              </html>
